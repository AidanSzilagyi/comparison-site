{% extends "../base.html" %}
{% load static %}
{% load permissions %}
{% block extra_head %}  
    <script src="{% static 'scripts/createList.js' %}"></script>
    <link rel="stylesheet" href="{% static 'styles/modify_list/createList.css' %}">
    {% if list_type == "text" %}
        <link rel="stylesheet" href="{% static 'styles/modify_list/text-create.css' %}">
    {% elif list_type == "image" %}
        <link rel="stylesheet" href="{% static 'styles/modify_list/image-create.css' %}">
    {% endif %}
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            /* Handle invite users popup when invite radio selector is changed */
            const inviteContainer = document.getElementById("invite-users-container");
            const radios = document.querySelectorAll('.js-permission-radio');

            function handleChange(event) {
                const requiresInvite = event.target.dataset.requiresInvite === "True";
                inviteContainer.style.display = requiresInvite ? "block" : "none";
            }
            radios.forEach(radio => {
                radio.addEventListener("change", handleChange);
            });

            handleChange({ target: document.querySelector('.js-permission-radio:checked') });
        });

    </script>
{% endblock %}

{% block main %}
	<main class="main-container">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ thing_forms.management_form }}
            <div class="page-header">
                <div class="page-title">
                    {% if new_list %}
                        Create a New List
                    {% else %}
                        Edit List
                    {% endif %}
                </div>
                <div class="create-list-button-container">
                    <button class="create-list-button" type="submit">
                        {% if new_list %}
                            Create
                        {% else %}
                            Save
                        {% endif %}
                    </button>
                </div>
            </div>
            <div class="list-details">
                <label style="display: none;" for="{{list_form.name.id_for_label}}">List Title</label>
                <input class="list-name-input text-input" 
                    id="{{list_form.name.id_for_label}}" 
                    name="{{list_form.name.html_name}}" 
                    value="{{list_form.name.value|default_if_none:''}}"
                    type="text" placeholder="Title">
                
                <label style="display: none;" for="{{list_form.description.id_for_label}}">List Description</label>
                <div class="horizontal-input-container">
                    <textarea class="list-description-input text-input" 
                        id="{{list_form.description.id_for_label}}" 
                        name="{{list_form.description.html_name }}"
                        rows="4" 
                        placeholder="Enter a description...">{{list_form.description.value|default_if_none:''}}</textarea>

                    <div class="list-image-container">
                        <label class="list-file-input" for="{{list_form.image.id_for_label}}"> 
                            {% if list_form.image.value %}
                                <div class="unselected-list-image js-unselected-list-image" style="display: none;">Choose Image</div>
                                <img class="selected-list-image js-selected-list-image" src="{{list_form.image.value.url}}">
                            {% else %}
                                <div class="unselected-list-image js-unselected-list-image">Choose Image</div>
                                <img class="selected-list-image js-selected-list-image" style="display: none;" src="">
                            {% endif %}
                        </label> 
                        <input style="display: none;" class="js-list-image-input"
                            id="{{list_form.image.id_for_label}}"
                            name="{{list_form.image.html_name}}"
                            value="{{list_form.image.value}}" 
                            type="file" accept="image/*">

                        {% if list_form.image.value %}
                            <div id="js-remove-list-image" class="remove-list-image-button">
                                Remove Image
                            </div>
                        {% else %}
                            <div id="js-remove-list-image" class="remove-list-image-button" style="display: none;">
                                Remove Image
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="multiple-choice-options">
                    <div class="radio-input-container">
                        <div class="radio-input-title">Comparison Model</div>
                        <div class="radio-input">
                            {% for value, label in list_form.fields.comparison_method.choices %}
                                <label class="label">
                                    <input type="radio" 
                                        name="{{ list_form.comparison_method.html_name }}" value="{{ value }}"
                                        {% if list_form.comparison_method.value == value %}checked{% endif %}>
                                    <p class="radio-input-text">{{ label }}</p>
                                </label>
                            {% endfor %}
                            </div>
                    </div>
                    <div class="permissions-container">
                        <div class="radio-input-container">
                            <div class="radio-input-title">Visibility</div>
                            <div class="radio-input">
                                {% for value, label in list_form.fields.permission.choices %}
                                    <label class="label">
                                        <input type="radio" 
                                            name="{{ list_form.permission.html_name }}" value="{{ value }}"
                                            class="js-permission-radio"
                                            data-description="{{ value|permission_description }}"
                                            data-requires-invite="{{ value|requires_invite }}"
                                            {% if list_form.permission.value == value %}checked{% endif %}>
                                        <p class="radio-input-text">{{ label }}</p>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                        <div>
                            <p class="permission-details" id="permission-details"></p>
                        </div>
                    </div>
                    <div id="invite-users-container" class="invite-users-container">
                        <div class="invite-users-title">Invite Users</div>
                        <div class="invite-users-instructions">Enter usernames or emails<br>(comma-seperated):</div>
                        <textarea class="invite-username-input text-input" name="invited-users">{{invited_users}}</textarea>
                    </div>
                </div>

                <div class="error-text">
                    {% for errors in list_form.errors.values %}
                        {% for error in errors %}
                            {{ error }} <br>
                        {% endfor %}
                    {% endfor %}
                    {% for error in list_form.non_field_errors %}
                        {{ error }} <br>
                    {% endfor %}
                    {% for error in thing_forms.non_form_errors %}
                        {{ error }} <br>
                    {% endfor %}
                </div>
            </div>
            <div class="list-of-things-header">1321 Things</div>
            {% if list_type == 'text' %}
                {% include "./text-create.html" with thing_forms=thing_forms %}
            {% elif list_type == 'image' %}
                {% include "./image-create.html" with thing_forms=thing_forms %}
            {% endif %}
        </form>
	</main>
    <div class="error-text">
        {% for errors in form.errors.values %}
            {% for error in errors %}
                {{ error }} <br>
            {% endfor %}
        {% endfor %}

        {% for error in form.non_field_errors %}
            {{ error }} <br>
        {% endfor %}
    </div>
{% endblock %}